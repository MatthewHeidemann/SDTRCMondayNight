
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Monday Night Doubles – RSVP</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="./firebase.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    h1 { text-align: center; }
    .form-section { margin-top: 30px; }
    .section-title { font-weight: bold; margin-top: 20px; }
    .player { padding-left: 20px; }
  </style>
</head>
<body>

<h1 id="header-date">Monday Night Doubles – </h1>

<div class="form-section">
  <label for="player-name">Select your name:</label>
  <select id="player-name">
    <option value="">-- Choose your name --</option>
  </select><br><br>

  <label><input type="radio" name="status" value="Yes"> Yes, I'm in</label><br>
  <label><input type="radio" name="status" value="No"> No, not this week</label><br>
  <button onclick="submitResponse()">Submit / Update</button>
</div>

<div class="form-section">
  <div class="section-title">In:</div>
  <div id="in-list"></div>
  <div class="section-title">Pending:</div>
  <div id="pending-list"></div>
  <div class="section-title">Out:</div>
  <div id="out-list"></div>
</div>

<script>
  const db = firebase.database();

  function getMondayDate() {
    const today = new Date();
    const nextMonday = new Date(today.setDate(today.getDate() + ((1 + 7 - today.getDay()) % 7 || 7)));
    return nextMonday.toISOString().split('T')[0];
  }

  document.getElementById("header-date").innerText = "Monday Night Doubles – " + getMondayDate();

  function submitResponse() {
    const name = document.getElementById("player-name").value;
    const statusInput = document.querySelector('input[name="status"]:checked');
    if (!name || !statusInput) {
      alert("Please select both name and status.");
      return;
    }
    const status = statusInput.value;
    const timestamp = Date.now();
    const weekKey = getMondayDate();

    db.ref("responses/" + weekKey + "/" + name).set({
      name: name,
      status: status,
      timestamp: timestamp
    });
  }

  function loadResponses() {
    const weekKey = getMondayDate();
    db.ref("responses/" + weekKey).on("value", (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      const inList = [];
      const pendingList = [];
      const outList = [];

      const yesResponses = [];
      for (const name in data) {
        if (data[name].status === "Yes") {
          yesResponses.push({ name: name, timestamp: data[name].timestamp });
        } else {
          outList.push(name);
        }
      }

      yesResponses.sort((a, b) => a.timestamp - b.timestamp);
      yesResponses.forEach((entry, index) => {
        if ((index + 1) % 4 === 0) {
          inList.push(entry.name);
        } else {
          pendingList.push(entry.name);
        }
      });

      document.getElementById("in-list").innerHTML = inList.map(n => `<div class="player">${n}</div>`).join("");
      document.getElementById("pending-list").innerHTML = pendingList.map(n => `<div class="player">${n}</div>`).join("");
      document.getElementById("out-list").innerHTML = outList.map(n => `<div class="player">${n}</div>`).join("");
    });
  }

  function loadPlayers() {
    db.ref("users").once("value").then(snapshot => {
      const players = snapshot.val();
      if (!players) return;
      const dropdown = document.getElementById("player-name");
      for (const key in players) {
        const opt = document.createElement("option");
        opt.value = players[key];
        opt.text = players[key];
        dropdown.appendChild(opt);
      }
    });
  }

  loadPlayers();
  loadResponses();
</script>

</body>
</html>
