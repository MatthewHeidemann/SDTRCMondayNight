<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monday Night Doubles 🎾</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
    header { background: white; padding: 1rem; text-align: center; font-size: 1.5rem; position: sticky; top: 0; border-bottom: 1px solid #ddd; }
    main { max-width: 600px; margin: 2rem auto; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    select, button { display: block; width: 100%; margin: 1rem 0; padding: 0.5rem; font-size: 1rem; }
    .availability label { margin-right: 1rem; }
    ul { padding: 0; list-style: none; }
    h2 { margin-top: 2rem; font-size: 1.2rem; }
  </style>
</head>
<body>
  <header>Monday Night Doubles 🎾</header>
  <main>
    <section id="rsvp">
      <label for="playerSelect">Select Your Name:</label>
      <select id="playerSelect">
        <option value="">Loading players...</option>
      </select>

      <div class="availability">
        <label><input type="radio" name="availability" value="Yes"> Yes</label>
        <label><input type="radio" name="availability" value="No"> No</label>
      </div>

      <button id="submitBtn">Submit RSVP</button>
    </section>

    <section id="results">
      <h2>In 🎾</h2>
      <ul id="inList"></ul>

      <h2>Pending ⏳</h2>
      <ul id="pendingList"></ul>

      <h2>Out 🚫</h2>
      <ul id="outList"></ul>
    </section>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
  <script src="firebase.js"></script>
  <script>
    const db = firebase.database();

    function getMondayKey() {
      const now = new Date();
      const day = now.getDay();
      const monday = new Date(now);
      monday.setDate(now.getDate() - day + (day === 0 ? -6 : 1));
      return monday.toISOString().split("T")[0];
    }

    function renderList(id, players) {
      const ul = document.getElementById(id);
      ul.innerHTML = "";
      players.forEach(name => {
        const li = document.createElement("li");
        li.textContent = name;
        ul.appendChild(li);
      });
    }

    function loadPlayers() {
      db.ref("/users").once("value").then(snapshot => {
        const select = document.getElementById("playerSelect");
        select.innerHTML = "<option value=''>Select your name</option>";
        snapshot.forEach(child => {
          const name = child.val();
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });
      });
    }

    function isWeekLocked(mondayKey) {
      return db.ref("/state/" + mondayKey + "/locked").once("value").then(snapshot => !!snapshot.val());
    }

    function submitRSVP() {
      const name = document.getElementById("playerSelect").value;
      const val = document.querySelector("input[name='availability']:checked")?.value;
      if (!name || !val) return alert("Please complete the form.");
      const mondayKey = getMondayKey();

      isWeekLocked(mondayKey).then(locked => {
        if (locked) {
          alert("RSVP is locked for this week.");
        } else {
          db.ref("/responses/" + mondayKey + "/" + name).set(val).then(loadResponses);
        }
      });
    }

    function loadResponses() {
      const mondayKey = getMondayKey();
      db.ref("/responses/" + mondayKey).on("value", snapshot => {
        const yes = [], no = [];
        snapshot.forEach(child => {
          const name = child.key;
          const response = child.val();
          if (response === "Yes") yes.push(name);
          else no.push(name);
        });
        const inPlayers = yes.slice(0, Math.floor(yes.length / 4) * 4);
        const pending = yes.slice(Math.floor(yes.length / 4) * 4);
        renderList("inList", inPlayers);
        renderList("pendingList", pending);
        renderList("outList", no);
      });
    }

    document.getElementById("submitBtn").addEventListener("click", submitRSVP);
    document.addEventListener("DOMContentLoaded", () => {
      loadPlayers();
      loadResponses();
    });
  </script>
</body>
</html>
